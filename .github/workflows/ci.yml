name: CI - Build C project

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config || true

      - name: Build and quick-run C project
        shell: bash
        run: |
          set -euo pipefail
          echo "Detecting build system..."

          # CMake
          if [ -f "CMakeLists.txt" ]; then
            echo "Detected CMake project"
            mkdir -p build
            cd build
            cmake -DCMAKE_BUILD_TYPE=Release ..
            cmake --build . -- -j$(nproc)
            if command -v ctest >/dev/null 2>&1; then
              echo "Running ctest (if any)"
              ctest --output-on-failure || true
            fi
            echo "CMake build finished"
            exit 0
          fi

          # Makefile
          if [ -f "Makefile" ] || [ -f "makefile" ]; then
            echo "Detected Makefile"
            make -j$(nproc)
            # try common test targets but do not fail CI if tests are absent
            if make -n test >/dev/null 2>&1; then
              make test || true
            elif make -n check >/dev/null 2>&1; then
              make check || true
            fi
            echo "Make build finished"
            exit 0
          fi

          # Fallback: compile all tracked .c files with gcc
          c_sources=$(git ls-files '*.c' || true)
          if [ -n "$c_sources" ]; then
            echo "No CMake/Makefile found â€” compiling all tracked .c files with gcc"
            echo "$c_sources"
            # compile into a single binary; adjust flags as needed
            gcc -O2 -std=gnu11 -Wall -Wextra -Werror -o socksify_bin $c_sources
            echo "Compilation succeeded, binary: ./socksify_bin"
            if [ -x ./socksify_bin ]; then
              echo "Running binary for a short smoke test (3s timeout)..."
              # run for a short time to ensure it starts (prevents long-running servers from hanging CI)
              timeout 3 ./socksify_bin || true
            fi
            exit 0
          fi

          echo "No known C build system or .c sources detected. Please update .github/workflows/ci.yml with project-specific commands."
          exit 1
